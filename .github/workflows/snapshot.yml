name: Generar RSS de Crunchyroll

on:
  push:
 # Feed Oficial en espa√±ol https://www.crunchyroll.com/rss?lang=esLA
 ############################COMMENTED###########################
 #Crunchyroll actualiza series cada media hora aproximadamente  #
 ################################################################
  schedule:
   - cron: '*/15 * * * *'   # Ejecuta cada 15 minutos
  workflow_dispatch:
 ################################################################

jobs:
  render-html:
    runs-on: ubuntu-latest

    steps:
      - name: Clona el repositorio
        uses: actions/checkout@v4

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-        


      - name: Instala dependencias
        run: |
            n=0
            echo "Instalando dependencias..."   # Mensaje del primer intento
            until [ "$n" -ge 5 ]
            do
              if [ "$n" -gt 0 ]; then
                echo "Intento $((n+1)) de instalar dependencias..." # Mensaje de reintentos
              fi

              npm ci && break

              n=$((n+1))
              echo "‚ùå Intento $n fallido. Reintentando en 30s..."
              sleep 30
            done

            if [ "$n" -ge 5 ]; then
              echo "‚ùå npm ci fall√≥ despu√©s de 5 intentos."
              exit 1
            fi

      - name: Cache Puppeteer Chromium
        uses: actions/cache@v4
        with:
          path: ~/.cache/puppeteer
          key: ${{ runner.os }}-puppeteer


      - name: Instala Chromium para Puppeteer
        run: |
            n=0
            echo "Instalando Chromium para Puppeteer..."   # Mensaje del primer intento
            until [ "$n" -ge 5 ]
            do
              if [ "$n" -gt 0 ]; then
                echo "Intento $((n+1)) de instalar Chromium..." # Mensaje de reintentos
              fi

              npx puppeteer install && break

              n=$((n+1))
              echo "‚ùå Intento $n fallido. Reintentando en 30s..."
              sleep 30
            done

            if [ "$n" -ge 5 ]; then
              echo "‚ùå Fall√≥ la instalaci√≥n de Chromium despu√©s de 5 intentos."
              exit 1
            fi

      - name: Ejecuta script para renderizar HTML
        run: node snapshot.js

      - name: Genera RSS a partir del HTML
        run: node generate-rss.js

      - name: Sube HTML y RSS generados
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add simulcast.html docs/simulcast-rss.xml
          git commit -m "üíïUpdate simulcast.html y RSS [auto]" || echo "No changes to commit"
          git remote set-url origin https://x-access-token:${GIT_AUTH_TOKEN}@github.com/${{ github.repository }}
          git push
